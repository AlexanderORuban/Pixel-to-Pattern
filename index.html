<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pixel to Pattern - Crochet Pattern Generator</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0; padding: 0;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }
  /* Sticky controls bar stays visible on scroll */
  #controls {
    position: sticky;
    top: 0;
    background: #fff;
    padding: 10px;
    border-bottom: 1px solid #ddd;
    z-index: 10;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    align-items: center;
  }
  #controls > * {
    margin: 0 5px;
  }

  /* Grid container for pixel drawing */
  #grid {
    display: grid;
    margin: 15px auto;
    border: 1px solid #ccc;
    user-select: none;
  }

  /* Each pixel box */
  .pixel {
    width: 25px;
    height: 25px;
    border: 1px solid #ddd;
    box-sizing: border-box;
  }

  /* Tool buttons styling */
  button {
    padding: 6px 12px;
    cursor: pointer;
  }
  button.selected {
    background-color: #4caf50;
    color: white;
  }

  /* Color picker size */
  input[type=color] {
    width: 36px;
    height: 36px;
    padding: 0;
    border: none;
    cursor: pointer;
  }

  /* Output box styles */
  #patternOutput {
    white-space: pre-wrap; /* preserve line breaks */
    height: 250px;         /* tall enough to see multiple lines */
    overflow-y: auto;      /* vertical scroll if content overflows */
    border: 1px solid #ccc;
    padding: 10px;
    font-family: monospace;
    background: #f9f9f9;
    margin: 15px auto;
    max-width: 90vw;
    resize: vertical;      /* user can resize output height */
  }

  /* Input sizes for canvas resizing */
  input[type=number] {
    width: 60px;
    padding: 5px;
  }
</style>
</head>
<body>

<!-- Controls bar with tools, color picker, canvas size inputs, image upload, and buttons -->
<div id="controls">
  <button id="pencilBtn" class="selected" title="Pencil tool (draw pixel)">Pencil</button>
  <button id="eraserBtn" title="Eraser tool (erase pixel)">Eraser</button>
  <button id="fillBtn" title="Fill entire canvas with current color">Fill Canvas</button>
  <button id="clearBtn" title="Clear entire canvas">Clear Canvas</button>

  <label for="colorPicker" title="Select drawing color">Color:</label>
  <input type="color" id="colorPicker" value="#ffff00" />

  <label for="canvasWidthInput" title="Canvas width (pixels)">Width:</label>
  <input type="number" id="canvasWidthInput" min="5" max="50" value="30" />

  <label for="canvasHeightInput" title="Canvas height (pixels)">Height:</label>
  <input type="number" id="canvasHeightInput" min="5" max="50" value="30" />

  <button id="resizeCanvasBtn" title="Resize the drawing canvas (5 to 50 pixels)">Resize Canvas</button>

  <input type="file" id="imageUpload" accept="image/*" title="Upload image to convert to pixel pattern" />

  <button id="generatePatternBtn" title="Generate crochet pattern instructions">Generate Pattern</button>
</div>

<!-- The pixel drawing grid -->
<div id="grid"></div>

<!-- Output box for crochet pattern instructions -->
<pre id="patternOutput" aria-label="Crochet pattern instructions will appear here">Draw your design or upload an image, then click Generate Pattern.</pre>

<!-- Hidden canvas for image processing -->
<canvas id="hiddenCanvas" style="display:none;"></canvas>

<script>
  // ======= Setup references to DOM elements =======
  const grid = document.getElementById('grid');
  const pencilBtn = document.getElementById('pencilBtn');
  const eraserBtn = document.getElementById('eraserBtn');
  const fillBtn = document.getElementById('fillBtn');
  const clearBtn = document.getElementById('clearBtn');
  const colorPicker = document.getElementById('colorPicker');
  const canvasWidthInput = document.getElementById('canvasWidthInput');
  const canvasHeightInput = document.getElementById('canvasHeightInput');
  const resizeCanvasBtn = document.getElementById('resizeCanvasBtn');
  const generateBtn = document.getElementById('generatePatternBtn');
  const patternOutput = document.getElementById('patternOutput');
  const imageUpload = document.getElementById('imageUpload');
  const hiddenCanvas = document.getElementById('hiddenCanvas');
  const hiddenCtx = hiddenCanvas.getContext('2d');

  // ======= Initial settings =======
  let currentTool = 'pencil';
  let currentColor = colorPicker.value;
  let canvasWidth = parseInt(canvasWidthInput.value);
  let canvasHeight = parseInt(canvasHeightInput.value);

  // Predefined colors used for matching uploaded images to closest crochet colors
  // You can expand or customize this list if needed
  const colors = [
    { value: '#ffffff', rgb: [255, 255, 255] }, // white
    { value: '#ffff00', rgb: [255, 255, 0] },   // yellow
    { value: '#000000', rgb: [0, 0, 0] },       // black
    { value: '#ff0000', rgb: [255, 0, 0] },     // red
    { value: '#00ff00', rgb: [0, 255, 0] },     // green
    { value: '#0000ff', rgb: [0, 0, 255] },     // blue
  ];

  // ======= Update the UI buttons to show selected tool =======
  function updateToolButtons() {
    pencilBtn.classList.toggle('selected', currentTool === 'pencil');
    eraserBtn.classList.toggle('selected', currentTool === 'eraser');
  }

  // ======= Build the pixel grid based on width and height =======
  function buildGrid(width, height) {
    grid.style.gridTemplateColumns = `repeat(${width}, 25px)`;
    grid.style.gridTemplateRows = `repeat(${height}, 25px)`;
    grid.innerHTML = '';
    for (let i = 0; i < width * height; i++) {
      const pixel = document.createElement('div');
      pixel.classList.add('pixel');
      pixel.dataset.color = 'white';
      pixel.style.backgroundColor = 'white';

      pixel.addEventListener('mousedown', onPixelInteraction);
      pixel.addEventListener('mouseenter', onPixelInteractionWhileMouseDown);

      grid.appendChild(pixel);
    }
  }

  // ======= Track if mouse button is held down for drawing while dragging =======
  let mouseDown = false;
  document.body.addEventListener('mousedown', () => { mouseDown = true; });
  document.body.addEventListener('mouseup', () => { mouseDown = false; });

  // ======= Handle coloring or erasing pixels on click =======
  function onPixelInteraction(e) {
    if (currentTool === 'pencil') {
      e.target.dataset.color = currentColor;
      e.target.style.backgroundColor = currentColor;
    } else if (currentTool === 'eraser') {
      e.target.dataset.color = 'white';
      e.target.style.backgroundColor = 'white';
    }
  }
  // ======= Handle drawing while dragging mouse over pixels =======
  function onPixelInteractionWhileMouseDown(e) {
    if (mouseDown) {
      onPixelInteraction(e);
    }
  }

  // ======= Fill entire canvas with current color =======
  function fillCanvas() {
    grid.querySelectorAll('.pixel').forEach(pixel => {
      pixel.dataset.color = currentColor;
      pixel.style.backgroundColor = currentColor;
    });
  }

  // ======= Clear entire canvas to white =======
  function clearCanvas() {
    grid.querySelectorAll('.pixel').forEach(pixel => {
      pixel.dataset.color = 'white';
      pixel.style.backgroundColor = 'white';
    });
  }

  // ======= Generate crochet pattern instructions based on pixel colors =======
  function generatePattern() {
    let patternText = '';
    const pixels = Array.from(grid.querySelectorAll('.pixel'));
    for (let row = 0; row < canvasHeight; row++) {
      let rowPixels = pixels.slice(row * canvasWidth, (row + 1) * canvasWidth);
      let count = 1;
      let prevColor = rowPixels[0].dataset.color;
      let parts = [];

      for (let i = 1; i < rowPixels.length; i++) {
        const currColor = rowPixels[i].dataset.color;
        if (currColor === prevColor) {
          count++;
        } else {
          parts.push(`${count} sc (${prevColor})`);
          count = 1;
          prevColor = currColor;
        }
      }
      parts.push(`${count} sc (${prevColor})`);
      patternText += `Row ${row + 1}: ${parts.join(', ')}\n`;
    }
    // Insert line breaks as <br> tags for display, preserves formatting
    patternOutput.innerHTML = patternText.replace(/\n/g, '<br>');
  }

  // ======= Process uploaded image to pixelate and map colors onto the grid =======
  imageUpload.addEventListener('change', event => {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = e => {
      const img = new Image();
      img.onload = () => {
        // Set hidden canvas to current pixel grid size for resizing the image
        hiddenCanvas.width = canvasWidth;
        hiddenCanvas.height = canvasHeight;

        // Clear hidden canvas and draw uploaded image resized to pixel grid size
        hiddenCtx.clearRect(0, 0, hiddenCanvas.width, hiddenCanvas.height);
        hiddenCtx.drawImage(img, 0, 0, img.width, img.height, 0, 0, canvasWidth, canvasHeight);

        // Get pixel data from resized image
        const imageData = hiddenCtx.getImageData(0, 0, canvasWidth, canvasHeight);
        const data = imageData.data;

        // Update grid pixels to closest matching color from predefined palette
        const pixels = Array.from(grid.querySelectorAll('.pixel'));
        for (let i = 0; i < canvasWidth * canvasHeight; i++) {
          const r = data[i * 4];
          const g = data[i * 4 + 1];
          const b = data[i * 4 + 2];

          let closestColor = colors[0].value;
          let minDist = Infinity;
          for (const c of colors) {
            const dr = r - c.rgb[0];
            const dg = g - c.rgb[1];
            const db = b - c.rgb[2];
            const dist = dr * dr + dg * dg + db * db;
            if (dist < minDist) {
              minDist = dist;
              closestColor = c.value;
            }
          }
          pixels[i].dataset.color = closestColor;
          pixels[i].style.backgroundColor = closestColor;
        }

        // Notify user to generate pattern now
        patternOutput.textContent = 'Image uploaded and processed. Click "Generate Pattern" to see crochet instructions.';
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  });

  // ======= Event Listeners for tool buttons and inputs =======
  pencilBtn.addEventListener('click', () => {
    currentTool = 'pencil';
    updateToolButtons();
  });

  eraserBtn.addEventListener('click', () => {
    currentTool = 'eraser';
    updateToolButtons();
  });

  fillBtn.addEventListener('click', fillCanvas);
  clearBtn.addEventListener('click', clearCanvas);

  // Resize canvas and rebuild grid when requested
  resizeCanvasBtn.addEventListener('click', () => {
    const w = parseInt(canvasWidthInput.value);
    const h = parseInt(canvasHeightInput.value);

    // Enforce size limits for usability
    if (w >= 5 && w <= 50 && h >= 5 && h <= 50) {
      canvasWidth = w;
      canvasHeight = h;
      buildGrid(canvasWidth, canvasHeight);
      patternOutput.textContent = 'Canvas resized. Draw your design or upload an image.';
      imageUpload.value = '';
    } else {
      alert('Canvas size must be between 5 and 50 pixels.');
    }
  });

  // Generate pattern instructions when button clicked
  generateBtn.addEventListener('click', generatePattern);

  // ======= Initialize grid and UI on page load =======
  buildGrid(canvasWidth, canvasHeight);
  updateToolButtons();
</script>

</body>
</html>