# This docker compose sets up one-shot test runner containers and test overrides
# Contains:
# - backend-integration (integration tests)
# - backend-unit-tests (unit tests)
# - frontend-tests (Jest)
# - frontend-web (Next.js server for Cypress)
# - backend-web (API server for Cypress)
# - e2e-tests (Cypress)

services:
  db-test:
    image: mysql:8.0
    container_name: db-test
    environment:
      MYSQL_ROOT_PASSWORD: testpass
      MYSQL_DATABASE: test_db
      MYSQL_USER: testuser
      MYSQL_PASSWORD: testpass
    tmpfs:
      - /var/lib/mysql
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -ptestpass --silent"]
      interval: 2s
      timeout: 2s
      retries: 30

  backend-integration:
    build: ./server
    container_name: backend-integration
    depends_on:
      db-test:
        condition: service_healthy
    environment:
      NODE_ENV: test
      DB_HOST: db-test
      DB_PORT: "3306"
      DB_USER: testuser
      DB_PASSWORD: testpass
      DB_DATABASE: test_db
    command: >
      sh -lc "npm run test:integration"

  backend-unit-tests:
    build: ./server
    container_name: backend-unit-tests
    environment:
      NODE_ENV: test
    command: >
      sh -lc "npm run test:unit"

  frontend-tests:
    build: ./client
    container_name: frontend-tests
    environment:
      CI: "true"
      NODE_ENV: test
    command: >
      sh -lc "npm run test:ci"

  # === FRONTEND WEB (Next.js) ===
  frontend-web:
    image: node:20
    container_name: frontend-web
    working_dir: /app
    volumes:
      - ./client:/app
    environment:
      PORT: "3001"
      # Frontend should call API via this URL inside the network
      NEXT_PUBLIC_API_URL: http://backend-web:3000
    healthcheck:
      test: 
        [ "CMD-SHELL",
        "node -e \"require('http').get('http://localhost:3001',r=>process.exit(r.statusCode===200?0:1)).on('error',()=>process.exit(1))\""
        ]
      interval: 3s
      timeout: 2s
      retries: 60
    ports:
      - "3001:3001"
    command: >
      sh -lc "
        npm ci &&
        npm run build &&
        npm run start -- -p 3001 -H 0.0.0.0
      "

  # === BACKEND WEB (runs the API for Cypress) ===
  backend-web:
    build: ./server
    container_name: backend-web
    environment:
      NODE_ENV: test
      DB_HOST: db-test
      DB_PORT: "3306"
      DB_USER: testuser
      DB_PASSWORD: testpass
      DB_DATABASE: test_db
      PORT: "3000"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:3000/health || exit 1"]
      interval: 3s
      timeout: 2s
      retries: 30
    depends_on:
      db-test:
        condition: service_healthy
    command: "node server.js"

  # === CYPRESS (E2E) ===
  e2e-tests:
    image: cypress/included:13.7.0
    container_name: e2e-tests
    working_dir: /e2e
    volumes:
      - ./cypress:/e2e/cypress
      - ./cypress.config.js:/e2e/cypress.config.js
    environment:
      CYPRESS_baseUrl: http://frontend-web:3001
      NODE_ENV: test
    depends_on:
      frontend-web:
        condition: service_healthy
      backend-web:
        condition: service_healthy
    entrypoint: ["/bin/sh","-lc"]
    command: >
      'npx cypress run --project /e2e --e2e
      --spec "cypress/e2e/**/*.cy.{js,jsx,ts,tsx}" --browser chrome --quiet'
