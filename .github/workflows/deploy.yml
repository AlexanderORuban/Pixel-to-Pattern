name: Automated Deployment

# Workflow triggers only on successful merge to main branch
on:
  pull_request:
    types: [closed]
    branches: [ main ]

jobs:
  deploy:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      # Deploy via SSH to VM
      - name: Deploy to VM (Digital Ocean)
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          password: ${{ secrets.VM_PASSWORD }}
          script: |
            echo "*** Updating + Upgrading VM ***"
            sudo apt-get update -y
            yes | sudo DEBIAN_FRONTEND=noninteractive apt-get -yqq upgrade

            echo "*** Installing Docker Dependencies ***"
            sudo apt install -y ca-certificates curl gnupg lsb-release

            echo "*** Add Docker GPG Key and repo ***"
            sudo mkdir -p /etc/apt/keyrings
            curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | \
              sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

            echo "*** Install Docker engine and compose plugin ***"
            sudo apt update
            sudo apt install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

            echo "*** Removing old deployment folder ***"
            rm -rf ~/pixel-to-pattern

            echo "*** Cloning latest repo ***"
            git clone https://github.com/${{ github.repository }}.git ~/pixel-to-pattern

            echo "*** Moving into project directory ***"
            cd ~/pixel-to-pattern

            echo "*** Writing backend .env ***"
            cat << EENV > .env
            DB_HOST=${DB_HOST}
            DB_USER=${DB_USER}
            DB_PASSWORD=${DB_PASSWORD}
            DB_DATABASE=${DB_DATABASE}
            DB_PORT=${DB_PORT}
            SERVER_PORT=3000
            EENV

            echo "*** Writing frontend client/.env.production ***"
            mkdir -p client
            cd client
            cat << FRONTENV > .env.production
            NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
            FRONTENV
            cd ..

            echo "*** Cleaning old docker images ***"
            docker image prune -f

            echo "*** Building + Deploying containers using repo's compose file ***"
            docker compose -f docker-compose.deploy.yml up -d --build

            echo "*** Verifying Deployment ***"
            sleep 5
            curl -I http://localhost:3000 || exit 1

            echo "*** Deployment complete. Running containers: ***"
            docker ps

        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_DATABASE: ${{ secrets.DB_DATABASE }}
          DB_PORT: ${{ secrets.DB_PORT }}
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}